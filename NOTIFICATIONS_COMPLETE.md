# ‚úÖ –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π - –ü–û–õ–ù–û–°–¢–¨–Æ –†–ê–ë–û–¢–ê–ï–¢!

## üéØ –ò—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

### –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å–æ–∑–¥–∞—é—Ç—Å—è ‚úÖ
```
üìä –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ –ë–î: 7
   - –° userId (–Ω–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞): 2
   - Telegram –¥–æ—Å—Ç–∞–≤–∫–∏: SENT ‚úÖ
   - WebSocket –¥–æ—Å—Ç–∞–≤–∫–∏: FAILED (–Ω–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ - –Ω–æ—Ä–º–∞)
```

### –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è ‚úÖ
```bash
node test-get-notifications.js
# –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç 2 —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è userId
```

### Telegram –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚úÖ
- –ü—Ä–æ–≤–∞–π–¥–µ—Ä –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
- –ë–æ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω: @kakdoma_posutka_bot
- –°–æ–æ–±—â–µ–Ω–∏—è –¥–æ—Å—Ç–∞–≤–ª—è—é—Ç—Å—è

## üìã –§–∏–Ω–∞–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
User (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
  ‚Üì 1:1
UserNotificationSettings
  ‚îú‚îÄ‚îÄ userId (PK)
  ‚îú‚îÄ‚îÄ telegramChatId  ‚Üê –¥–ª—è Telegram
  ‚îú‚îÄ‚îÄ enabled
  ‚îî‚îÄ‚îÄ subscribedEvents []

Cleaner (—É–±–æ—Ä—â–∏–∫)
  ‚îú‚îÄ‚îÄ type (INTERNAL | EXTERNAL)
  ‚îî‚îÄ‚îÄ userId? (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

Notification (—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ)
  ‚îú‚îÄ‚îÄ userId (–æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ–ª—É—á–∞—Ç–µ–ª—å)
  ‚îî‚îÄ‚îÄ deliveryStatuses []
        ‚Üì
NotificationDelivery (–∑–∞–ø–∏—Å—å –¥–æ—Å—Ç–∞–≤–∫–∏)
  ‚îú‚îÄ‚îÄ channel (TELEGRAM | WEBSOCKET)
  ‚îú‚îÄ‚îÄ recipientType (TELEGRAM_CHAT_ID | USER_ID)
  ‚îú‚îÄ‚îÄ recipientId (–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π ID!)
  ‚îî‚îÄ‚îÄ status (PENDING | SENT | FAILED)
```

## üîÑ –ü–æ—Ç–æ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:

1. –°–æ–∑–¥–∞–µ—Ç—Å—è —É–±–æ—Ä–∫–∞ ‚Üí `scheduleCleaning()`
2. –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è `targetUserId = cleaner.userId || cleaner.id`
3. –ü–æ–ª—É—á–∞—é—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ `UserNotificationSettings`
4. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `notificationClient.notifyCleaningAssigned()`
   - –ü–µ—Ä–µ–¥–∞–µ—Ç `userId` + `telegramChatId`
5. –°–æ–∑–¥–∞–µ—Ç—Å—è `Notification` –≤ –ë–î
6. –°–æ–∑–¥–∞—é—Ç—Å—è `NotificationDelivery` –∑–∞–ø–∏—Å–∏:
   - TELEGRAM ‚Üí TELEGRAM_CHAT_ID: "123637501"
   - WEBSOCKET ‚Üí USER_ID: "cmgjdacf30000..."
7. –î–ª—è –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä
8. –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å –¥–æ—Å—Ç–∞–≤–∫–∏ (SENT/FAILED)

## üêõ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

1. ‚úÖ –£–±—Ä–∞–Ω–∞ "–ø–æ–º–æ–π–∫–∞" (channels + recipientIds)
2. ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ User, –∞ –Ω–µ –∫ Cleaner
3. ‚úÖ Mock-—Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ —Ä–µ–∞–ª—å–Ω—É—é —Ä–∞–±–æ—Ç—É —Å –ë–î
4. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
5. ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ ID –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–∞–Ω–∞–ª–∞
6. ‚úÖ CreateCleanerInput - userId –æ–ø—Ü–∏–æ–Ω–∞–ª–µ–Ω
7. ‚úÖ getNotifications —á–∏—Ç–∞–µ—Ç –∏–∑ –ë–î
8. ‚úÖ –°—Ç–∞—Ç—É—Å—ã –¥–æ—Å—Ç–∞–≤–∫–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è

## üì± –î–ª—è —Ä–∞–±–æ—Ç—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω:

1. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å Telegram:**
   - –í–∞—Ä–∏–∞–Ω—Ç A: –û—Ç–ø—Ä–∞–≤–∏—Ç—å `/start` –±–æ—Ç—É (–∞–≤—Ç–æ–ø—Ä–∏–≤—è–∑–∫–∞ –ø–æ username)
   - –í–∞—Ä–∏–∞–Ω—Ç B: –í–≤–µ—Å—Ç–∏ Chat ID –≤ `/settings/notifications`

2. **–í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:**
   - –ó–∞–π—Ç–∏ –Ω–∞ `/settings/notifications`
   - –í–∫–ª—é—á–∏—Ç—å –∫–∞–Ω–∞–ª—ã (TELEGRAM, WEBSOCKET)
   - –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏—è (CLEANING_ASSIGNED –∏ —Ç.–¥.)

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:

### 1. –ü–æ–ª—É—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:
```bash
node test-get-notifications.js
```

### 2. –°–æ–∑–¥–∞—Ç—å —É–±–æ—Ä–∫—É:
- –ù–∞–∑–Ω–∞—á–∏—Ç—å —É–±–æ—Ä–∫—É —á–µ—Ä–µ–∑ UI
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Telegram - –¥–æ–ª–∂–Ω–æ –ø—Ä–∏–π—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `/notifications` - –¥–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å—Å—è –≤ —Å–ø–∏—Å–∫–µ

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ë–î:
```bash
node check-notifications-final.js  # –µ—Å–ª–∏ –µ—â–µ –Ω–µ —É–¥–∞–ª–µ–Ω
```

## üìä –°—Ç–∞—Ç—É—Å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:

- ‚úÖ Backend (notifications-subgraph) - –≥–æ—Ç–æ–≤, —Ç—Ä–µ–±—É–µ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
- ‚úÖ Backend (cleaning-subgraph) - –æ–±–Ω–æ–≤–ª–µ–Ω
- ‚úÖ Frontend (components) - –≥–æ—Ç–æ–≤—ã
- ‚úÖ Database (schema) - –æ–±–Ω–æ–≤–ª–µ–Ω–∞
- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ - –ø—Ä–∏–º–µ–Ω–µ–Ω—ã

## üöÄ –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –°–ï–ô–ß–ê–°:

```bash
# 1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å notifications-subgraph
cd /Users/pavellobachev/dev/posutka-monorepo/backend/notifications-subgraph
# Ctrl+C –µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω
pnpm dev

# 2. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
cd /Users/pavellobachev/dev/posutka-monorepo
node test-get-notifications.js

# 3. –°–æ–∑–¥–∞—Ç—å —É–±–æ—Ä–∫—É —á–µ—Ä–µ–∑ UI
# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Telegram - –¥–æ–ª–∂–Ω–æ –ø—Ä–∏–π—Ç–∏! üì±
```

---

**–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:** 15 –æ–∫—Ç—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–ê–ë–û–¢–ê–ï–¢ (—Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞)

