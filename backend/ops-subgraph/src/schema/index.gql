# Ops Subgraph - Операционные задачи и сервисы
# Отвечает за управление задачами, поставщиками услуг и заказами на обслуживание

"""
Денежная сумма с валютой.
Amount хранится в копейках/центах для точности вычислений.
Пример: {amount: 150000, currency: "RUB"} = 1500.00 RUB
"""
type Money {
  """Сумма в копейках/центах (минимальная единица валюты)"""
  amount: Int!
  """Код валюты в формате ISO 4217 (RUB, USD, EUR)"""
  currency: String!
}

"""
Входные данные для денежной суммы.
Используется в мутациях для создания/обновления денежных значений.
"""
input MoneyInput {
  """Сумма в копейках/центах"""
  amount: Int!
  """Код валюты в формате ISO 4217"""
  currency: String!
}

"""
Информация о пагинации для соединений (connections).
Используется в GraphQL для реализации cursor-based пагинации.
"""
type PageInfo {
  """Есть ли следующая страница результатов"""
  hasNextPage: Boolean!
  """Есть ли предыдущая страница результатов"""
  hasPreviousPage: Boolean!
  """Курсор для начала текущей страницы"""
  startCursor: String
  """Курсор для конца текущей страницы"""
  endCursor: String
  """Общее количество элементов (опционально)"""
  totalCount: Int
}

"""
Действия с депозитом/залогом.
Используется для управления залогами при бронировании.
"""
enum DepositAction {
  """Заблокировать средства на карте гостя"""
  HOLD
  """Разблокировать заблокированные средства"""
  RELEASE
  """Списать средства с карты гостя"""
  CHARGE
  """Подтвердить списание (окончательно)"""
  CAPTURE
  """Вернуть средства гостю"""
  REFUND
}

"""
Статус транзакции в системе.
"""
enum TransactionStatus {
  """Транзакция в процессе обработки"""
  PENDING
  """Транзакция успешно завершена"""
  COMPLETED
  """Транзакция не удалась"""
  FAILED
}

"""
Каналы продаж для бронирований.
Определяет источник бронирования и платформу.
"""
enum Channel {
  """Прямое бронирование через сайт/приложение"""
  DIRECT
  """Бронирование через Airbnb"""
  AIRBNB
  """Бронирование через Booking.com"""
  BOOKING_COM
  """Бронирование через Avito"""
  AVITO
  """Другие каналы продаж"""
  OTHER
}


scalar UUID
scalar DateTime

"""
Организация (компания, отель, хостел и т.д.).
Ссылка на основную сущность из identity-subgraph.
"""
type Organization {
  """Уникальный идентификатор организации"""
  id: UUID!
}

"""
Единица недвижимости (номер, квартира, дом и т.д.).
Ссылка на основную сущность из inventory-subgraph.
"""
type Unit {
  """Уникальный идентификатор единицы недвижимости"""
  id: UUID!
}

"""
Бронирование недвижимости.
Ссылка на основную сущность из bookings-subgraph.
"""
type Booking {
  """Уникальный идентификатор бронирования"""
  id: UUID!
}

"""
Счет на оплату.
Ссылка на сущность из billing-subgraph.
"""
type Invoice {
  """Уникальный идентификатор счета"""
  id: UUID!
}

"""
Статус задачи.
Определяет текущее состояние выполнения задачи.
"""
enum TaskStatus {
  """Задача в черновике (для ежедневных уведомлений перед отправкой)"""
  DRAFT
  """Задача создана, ожидает выполнения"""
  TODO
  """Задача в процессе выполнения"""
  IN_PROGRESS
  """Задача выполнена"""
  DONE
  """Задача отменена"""
  CANCELED
}

"""
Тип задачи.
Определяет категорию и характер выполняемой задачи.
"""
enum TaskType {
  """Уборка помещения"""
  CLEANING
  """Заселение гостя"""
  CHECKIN
  """Выселение гостя"""
  CHECKOUT
  """Техническое обслуживание"""
  MAINTENANCE
  """Инвентаризация"""
  INVENTORY
  """Ежедневное уведомление о задачах"""
  DAILY_NOTIFICATION
}

"""
Поставщик услуг.
Компания или физическое лицо, предоставляющее услуги по обслуживанию недвижимости.
"""
type ServiceProvider {
  """Уникальный идентификатор поставщика услуг"""
  id: UUID!
  """Название поставщика услуг"""
  name: String!
  """Типы услуг, которые предоставляет поставщик"""
  serviceTypes: [TaskType!]!
  """Рейтинг поставщика (от 1.0 до 5.0, опционально)"""
  rating: Float
  """Контактная информация (телефон, email)"""
  contact: String
  """Дата и время добавления поставщика"""
  createdAt: DateTime!
  """Дата и время последнего обновления"""
  updatedAt: DateTime!
}

"""
Уборщик (ссылка на field-service-subgraph).
"""
type Cleaner {
  """Уникальный идентификатор уборщика"""
  id: UUID!
}

"""
Мастер (ссылка на field-service-subgraph).
"""
type Master {
  """Уникальный идентификатор мастера"""
  id: UUID!
}

"""
Уборка (ссылка на field-service-subgraph).
"""
type Cleaning {
  """Уникальный идентификатор уборки"""
  id: UUID!
}

type Repair {
  """Уникальный идентификатор ремонта"""
  id: UUID!
  """Статус ремонта"""
  status: RepairStatus!
  """Запланированное время"""
  scheduledAt: DateTime!
  """Время завершения"""
  completedAt: DateTime
  """Мастер"""
  master: Master
}

"""
Статус ремонта.
"""
enum RepairStatus {
  """Запланирован"""
  PLANNED
  """В процессе выполнения"""
  IN_PROGRESS
  """Завершен"""
  COMPLETED
  """Отменен"""
  CANCELLED
}

"""
Операционная задача.
Представляет задачу, которую необходимо выполнить для обслуживания недвижимости.
"""
type Task {
  """Уникальный идентификатор задачи"""
  id: UUID!
  """Организация, для которой создана задача"""
  org: Organization!
  """Единица недвижимости, к которой относится задача (опционально)"""
  unit: Unit
  """Бронирование, связанное с задачей (опционально)"""
  booking: Booking
  """Источник задачи (опционально)"""
  source: Source
  """Ключ пункта чек-листа, из которого создана задача (опционально, deprecated)"""
  checklistItemKey: String
  """ID пункта чек-листа, к которому привязана задача (опционально)"""
  checklistItemInstanceId: UUID
  """Задача для следующего чек-листа"""
  plannedForNextChecklist: Boolean!
  """ID уборки, из которой создана задача для следующего чек-листа (опционально)"""
  sourceCleaningId: UUID
  """Тип задачи"""
  type: TaskType!
  """Текущий статус задачи"""
  status: TaskStatus!
  """Дата и время, к которому должна быть выполнена задача (опционально)"""
  dueAt: DateTime
  """Поставщик услуг, назначенный на задачу (опционально)"""
  assignedTo: ServiceProvider
  """Уборщик, назначенный на задачу уборки (опционально, только для CLEANING)"""
  assignedCleaner: Cleaner
  """Мастер, назначенный на задачу (опционально, для ремонтов)"""
  assignedMaster: Master
  """Чек-лист для выполнения задачи"""
  checklist: [String!]!
  """Дата и время создания задачи"""
  createdAt: DateTime!
  """Дата и время последнего обновления"""
  updatedAt: DateTime!
  """Дополнительные заметки к задаче (опционально)"""
  note: String
}

"""
Заказ на услуги.
Представляет заказ поставщику услуг для выполнения конкретной задачи.
"""
type ServiceOrder {
  """Уникальный идентификатор заказа на услуги"""
  id: UUID!
  """Организация, разместившая заказ"""
  org: Organization!
  """Задача, для которой создан заказ"""
  task: Task!
  """Поставщик услуг, выполняющий заказ (опционально)"""
  provider: ServiceProvider
  """Статус заказа (например, "pending", "confirmed", "completed")"""
  status: String!
  """Стоимость услуг (опционально)"""
  cost: Money
  """Счет на оплату услуг (опционально)"""
  invoice: Invoice
  """Дата и время создания заказа"""
  createdAt: DateTime!
  """Дата и время последнего обновления"""
  updatedAt: DateTime!
  """Дополнительные заметки к заказу (опционально)"""
  notes: String
}


"""
Элемент списка задач для пагинации.
"""
type TaskEdge {
  """Задача"""
  node: Task!
  """Курсор для пагинации"""
  cursor: String!
}

"""
Соединение задач с пагинацией.
"""
type TaskConnection {
  """Список задач с курсорами"""
  edges: [TaskEdge!]!
  """Информация о пагинации"""
  pageInfo: PageInfo!
  """Общее количество задач (опционально)"""
  totalCount: Int
}

"""
Запросы для работы с задачами, заказами и поставщиками услуг.
"""
type Query {
  """Получить задачу по ID"""
  task(id: UUID!): Task
  """Получить список задач с фильтрацией и пагинацией"""
  tasks(
    """ID организации для фильтрации"""
    orgId: UUID!
    """Статус задач для фильтрации (опционально)"""
    status: TaskStatus
    """Тип задач для фильтрации (опционально)"""
    type: TaskType
    """Количество элементов на странице"""
    first: Int
    """Курсор для пагинации"""
    after: String
  ): TaskConnection!
  """Получить заказ на услуги по ID"""
  serviceOrder(id: UUID!): ServiceOrder
  """Получить поставщика услуг по ID"""
  serviceProvider(id: UUID!): ServiceProvider
  """Получить список поставщиков услуг с фильтрацией по типам услуг"""
  serviceProviders(serviceTypes: [TaskType!]): [ServiceProvider!]!
}

"""
Входные данные для создания задачи.
"""
input CreateTaskInput {
  """ID организации, для которой создается задача"""
  orgId: UUID!
  """Тип задачи"""
  type: TaskType!
  """ID единицы недвижимости (опционально)"""
  unitId: UUID
  """ID бронирования (опционально)"""
  bookingId: UUID
  """ID источника задачи (опционально)"""
  sourceId: UUID
  """Ключ пункта чек-листа, из которого создана задача (опционально, deprecated)"""
  checklistItemKey: String
  """ID пункта чек-листа, к которому привязана задача (опционально)"""
  checklistItemInstanceId: UUID
  """ID поставщика услуг (опционально, для не-CLEANING задач)"""
  assignedProviderId: UUID
  """Задача для следующего чек-листа"""
  plannedForNextChecklist: Boolean
  """ID уборки, из которой создана задача для следующего чек-листа (опционально)"""
  sourceCleaningId: UUID
  """ID уборщика (опционально, для CLEANING задач)"""
  assignedCleanerId: UUID
  """ID мастера (опционально, для ремонтов)"""
  assignedMasterId: UUID
  """Дата и время выполнения задачи (опционально)"""
  dueAt: DateTime
  """Чек-лист для выполнения задачи (опционально)"""
  checklist: [String!]
  """Дополнительные заметки (опционально)"""
  note: String
}

"""
Входные данные для назначения задачи.
"""
input AssignTaskInput {
  """ID задачи для назначения"""
  taskId: UUID!
  """ID поставщика услуг (опционально, используется для не-CLEANING задач)"""
  providerId: UUID
  """ID уборщика (опционально, используется для CLEANING задач)"""
  cleanerId: UUID
  """ID мастера (опционально, используется для ремонтов)"""
  masterId: UUID
  """Новый статус задачи (опционально)"""
  status: TaskStatus
  """Дополнительные заметки (опционально)"""
  note: String
}

"""
Входные данные для обновления задачи.
"""
input UpdateTaskInput {
  """Тип задачи (опционально)"""
  type: TaskType
  """Статус задачи (опционально)"""
  status: TaskStatus
  """Дополнительные заметки (опционально)"""
  note: String
  """Дата и время выполнения задачи (опционально)"""
  dueAt: DateTime
}

"""
Входные данные для создания заказа на услуги.
"""
input CreateServiceOrderInput {
  """ID задачи, для которой создается заказ"""
  taskId: UUID!
  """ID поставщика услуг (опционально)"""
  providerId: UUID
  """Стоимость услуг (опционально)"""
  cost: MoneyInput
  """Дополнительные заметки (опционально)"""
  notes: String
}

"""
Входные данные для создания поставщика услуг.
"""
input CreateServiceProviderInput {
  """Название поставщика услуг"""
  name: String!
  """Типы услуг, которые предоставляет поставщик"""
  serviceTypes: [TaskType!]!
  """Рейтинг поставщика (опционально)"""
  rating: Float
  """Контактная информация (опционально)"""
  contact: String
}

"""
Входные данные для создания задачи из пункта чек-листа.
"""
input ChecklistTaskItemInput {
  """Ключ пункта чек-листа"""
  itemKey: String!
  """Описание задачи (что нужно сделать)"""
  description: String!
  """ID исполнителя (assignee) - может быть providerId или cleanerId"""
  assigneeId: UUID!
  """Тип исполнителя (PROVIDER или CLEANER)"""
  assigneeType: TaskAssigneeType!
  """Дата исполнения (опционально)"""
  dueAt: DateTime
}

"""
Тип исполнителя задачи.
"""
enum TaskAssigneeType {
  """Поставщик услуг"""
  PROVIDER
  """Уборщик"""
  CLEANER
  """Мастер"""
  MASTER
}

"""
Входные данные для создания задач из чек-листа.
"""
input CreateTasksFromChecklistInput {
  """ID уборки, из которой берём неуспешные пункты (опционально, если указан repairId)"""
  cleaningId: UUID
  """ID ремонта, из которого берём неуспешные пункты (опционально, если указан cleaningId)"""
  repairId: UUID
  """Список пунктов для создания задач"""
  items: [ChecklistTaskItemInput!]!
}

"""
Входные данные для создания задачи для следующего чек-листа.
"""
input CreateTaskForNextChecklistInput {
  """ID организации"""
  orgId: UUID!
  """ID единицы недвижимости (обязательно)"""
  unitId: UUID!
  """ID уборки, из которой создается задача"""
  sourceCleaningId: UUID!
  """Тип задачи"""
  type: TaskType!
  """ID уборщика (опционально, для CLEANING задач)"""
  assignedCleanerId: UUID
  """ID поставщика услуг (опционально, для не-CLEANING задач)"""
  assignedProviderId: UUID
  """Дата и время выполнения задачи (опционально)"""
  dueAt: DateTime
  """Дополнительные заметки (опционально)"""
  note: String
}

"""
Входные данные для создания ежедневного уведомления о задачах.
"""
input CreateDailyNotificationTaskInput {
  """ID организации"""
  orgId: UUID!
  """Тип задач: CLEANING или REPAIR"""
  taskType: String!
  """Дата, на которую нужны задачи"""
  targetDate: DateTime!
}

"""
Входные данные для обновления задачи в ежедневном уведомлении.
"""
input UpdateDailyNotificationTaskItemInput {
  """ID задачи типа DAILY_NOTIFICATION"""
  taskId: UUID!
  """ID задачи (cleaningId или repairId) для обновления"""
  itemId: UUID!
  """Новое время выполнения (опционально)"""
  scheduledAt: DateTime
  """ID нового исполнителя (cleanerId или masterId, опционально)"""
  executorId: UUID
  """Заметки к задаче (опционально)"""
  notes: String
  """Сложность уборки 0-5 (опционально, только для уборок)"""
  difficulty: Int
  """ID шаблона чеклиста для уборки (опционально, только для уборок)"""
  templateId: UUID
}

"""
Источник задачи.
Может быть уборка, ремонт, бронирование и т.д.
"""
type Source {
  """Уникальный идентификатор источника"""
  id: UUID!
  """Тип источника"""
  type: SourceType!
  """ID сущности (cleaning.id, repair.id и т.д.)"""
  entityId: UUID!
  """Организация"""
  org: Organization!
  """Уборка (если type = CLEANING)"""
  cleaning: Cleaning
  """Ремонт (если type = REPAIR)"""
  repair: Repair
  """Дата создания"""
  createdAt: DateTime!
  """Дата обновления"""
  updatedAt: DateTime!
}

"""
Тип источника задачи.
"""
enum SourceType {
  """Уборка"""
  CLEANING
  """Ремонт"""
  REPAIR
  """Бронирование"""
  BOOKING
  """Инспекция"""
  INSPECTION
  """Другое"""
  OTHER
}

"""
Мутации для управления задачами, заказами и поставщиками услуг.
"""
type Mutation {
  """Создать новую задачу"""
  createTask(input: CreateTaskInput!): Task!
  """Создать задачи из неуспешных пунктов чек-листа уборки"""
  createTasksFromChecklist(input: CreateTasksFromChecklistInput!): [Task!]!
  """Создать задачу для следующего чек-листа"""
  createTaskForNextChecklist(input: CreateTaskForNextChecklistInput!): Task!
  """Создать задачу ежедневного уведомления о задачах на день"""
  createDailyNotificationTask(input: CreateDailyNotificationTaskInput!): Task!
  """Обновить задачу в ежедневном уведомлении (время, исполнитель)"""
  updateDailyNotificationTaskItem(input: UpdateDailyNotificationTaskItemInput!): Task!
  """Отправить ежедневное уведомление (публикует событие и меняет статус на TODO)"""
  sendDailyNotificationTask(taskId: UUID!): Task!
  """Назначить задачу поставщику услуг"""
  assignTask(input: AssignTaskInput!): Task!
  """Обновить статус задачи"""
  updateTaskStatus(id: UUID!, status: TaskStatus!): Task!
  """Обновить задачу"""
  updateTask(id: UUID!, input: UpdateTaskInput!): Task!
  """Создать заказ на услуги"""
  createServiceOrder(input: CreateServiceOrderInput!): ServiceOrder!
  """Обновить статус заказа на услуги"""
  updateServiceOrderStatus(id: UUID!, status: String!): ServiceOrder!
  """Создать нового поставщика услуг"""
  createServiceProvider(input: CreateServiceProviderInput!): ServiceProvider!
}
