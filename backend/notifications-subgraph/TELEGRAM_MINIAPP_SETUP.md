# üì± Telegram Mini App –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

## –ß—Ç–æ —ç—Ç–æ?

Telegram Mini App (Web App) –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –≤–∞—à–µ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ **–≤–Ω—É—Ç—Ä–∏ Telegram** –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–∏. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ –≤–Ω—É—Ç—Ä–∏ Telegram, –∞ –Ω–µ –≤–æ –≤–Ω–µ—à–Ω–µ–º –±—Ä–∞—É–∑–µ—Ä–µ.

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

‚úÖ **–õ—É—á—à–∏–π UX** - –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ Telegram  
‚úÖ **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram  
‚úÖ **–ù–∞—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å** - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å UI Telegram  
‚úÖ **–ë—ã—Å—Ç—Ä–µ–µ** - –Ω–µ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä  

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –û–±—ã—á–Ω–∞—è –∫–Ω–æ–ø–∫–∞ (TELEGRAM_USE_MINIAPP=false):
```json
{
  "text": "–û—Ç–∫—Ä—ã—Ç—å –¥–µ—Ç–∞–ª–∏ —É–±–æ—Ä–∫–∏ ‚Üí",
  "url": "https://app.posutka.com/cleanings?id=123"
}
```
‚Üí –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤–æ **–≤–Ω–µ—à–Ω–µ–º –±—Ä–∞—É–∑–µ—Ä–µ**

### Mini App –∫–Ω–æ–ø–∫–∞ (TELEGRAM_USE_MINIAPP=true):
```json
{
  "text": "–û—Ç–∫—Ä—ã—Ç—å –¥–µ—Ç–∞–ª–∏ —É–±–æ—Ä–∫–∏ ‚Üí",
  "web_app": { "url": "https://app.posutka.com/cleanings?id=123" }
}
```
‚Üí –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è **–≤–Ω—É—Ç—Ä–∏ Telegram** –≤ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ Mini App –∫ –±–æ—Ç—É

–í [@BotFather](https://t.me/BotFather):

```
/mybots
‚Üí –í—ã–±—Ä–∞—Ç—å –≤–∞—à–µ–≥–æ –±–æ—Ç–∞
‚Üí Bot Settings
‚Üí Menu Button
‚Üí Configure menu button
```

–í–≤–µ–¥–∏—Ç–µ:
- **Button text:** `–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ` (–∏–ª–∏ –ª—é–±–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ)
- **Web App URL:** `https://app.posutka.com` (–≤–∞—à production URL)

### 2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–í `.env` —Ñ–∞–π–ª–µ notifications-subgraph:

```env
# Telegram Bot
TELEGRAM_BOT_TOKEN=your_bot_token_here

# Mini App (–¥–ª—è production)
TELEGRAM_USE_MINIAPP=true

# Polling (–æ–±—ã—á–Ω–æ false –Ω–∞ production)
TELEGRAM_POLLING=false
```

### 3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥

–í–∞—à —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –¥–æ–ª–∂–µ–Ω –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å Telegram Web App API:

```html
<!-- –í index.html –¥–æ–±–∞–≤—å—Ç–µ —Å–∫—Ä–∏–ø—Ç Telegram -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>
```

```typescript
// –í –≤–∞—à–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
if (window.Telegram?.WebApp) {
  const tg = window.Telegram.WebApp;
  
  // –†–∞—Å—à–∏—Ä–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
  tg.expand();
  
  // –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const user = tg.initDataUnsafe?.user;
  console.log('Telegram user:', user);
  
  // –ù–∞—Å—Ç—Ä–æ–∏—Ç—å theme
  document.documentElement.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color);
  
  // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥" –≤ Telegram
  tg.BackButton.show();
  tg.BackButton.onClick(() => {
    tg.close(); // –ó–∞–∫—Ä—ã—Ç—å Mini App
  });
}
```

## –û–∫—Ä—É–∂–µ–Ω–∏—è

### Development (–ª–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞)

```env
# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–±—ã—á–Ω—ã–µ URL –∫–Ω–æ–ø–∫–∏
TELEGRAM_USE_MINIAPP=false
FRONTEND_URL=http://localhost:3000
```

‚Üí –°—Å—ã–ª–∫–∏ –±—É–¥—É—Ç –æ—Ç–∫—Ä—ã–≤–∞—Ç—å—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ (–ø—Ä–æ—â–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)

### Staging/Production

```env
# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Mini App
TELEGRAM_USE_MINIAPP=true
FRONTEND_URL=https://app.posutka.com
```

‚Üí –°—Å—ã–ª–∫–∏ –±—É–¥—É—Ç –æ—Ç–∫—Ä—ã–≤–∞—Ç—å—Å—è –≤–Ω—É—Ç—Ä–∏ Telegram

## –ü—Ä–∏–º–µ—Ä —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

### –ö–æ–≥–¥–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:

```
üßπ –ù–æ–≤–∞—è —É–±–æ—Ä–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞!

–í–∞–º –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ —É–±–æ—Ä–∫–∞ –≤ –∫–≤–∞—Ä—Ç–∏—Ä–µ "–ú–æ—Å–∫–≤–∞, –ê—Ä–±–∞—Ç 1"

–î–∞—Ç–∞: 20 –æ–∫—Ç—è–±—Ä—è 2025 –≥., 14:00
‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è —Å–º–µ–Ω–∞ –ø–æ—Å—Ç–µ–ª—å–Ω–æ–≥–æ –±–µ–ª—å—è

[–û—Ç–∫—Ä—ã—Ç—å –¥–µ—Ç–∞–ª–∏ —É–±–æ—Ä–∫–∏ ‚Üí]  ‚Üê –ö–Ω–æ–ø–∫–∞ Mini App
```

### –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É:

- ‚úÖ **–° Mini App:** –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è https://app.posutka.com/cleanings?id=123 **–≤–Ω—É—Ç—Ä–∏ Telegram**
- ‚ùå **–ë–µ–∑ Mini App:** –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è https://app.posutka.com/cleanings?id=123 –≤ **–±—Ä–∞—É–∑–µ—Ä–µ**

## –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram

–ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ Mini App –≤—ã –º–æ–∂–µ—Ç–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ Telegram:

```typescript
// –ù–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ
const initData = window.Telegram.WebApp.initData;

// –û—Ç–ø—Ä–∞–≤—å—Ç–µ initData –Ω–∞ –≤–∞—à –±—ç–∫–µ–Ω–¥
const response = await fetch('/api/auth/telegram', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ initData })
});

// –ù–∞ –±—ç–∫–µ–Ω–¥–µ –≤–∞–ª–∏–¥–∏—Ä—É–π—Ç–µ initData
import crypto from 'crypto';

function validateTelegramWebAppData(initData: string, botToken: string): boolean {
  const urlParams = new URLSearchParams(initData);
  const hash = urlParams.get('hash');
  urlParams.delete('hash');
  
  const dataCheckString = Array.from(urlParams.entries())
    .sort(([a], [b]) => a.localeCompare(b))
    .map(([key, value]) => `${key}=${value}`)
    .join('\n');
  
  const secretKey = crypto.createHmac('sha256', 'WebAppData').update(botToken).digest();
  const calculatedHash = crypto.createHmac('sha256', secretKey).update(dataCheckString).digest('hex');
  
  return calculatedHash === hash;
}
```

## –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Telegram

- [Telegram Mini Apps](https://core.telegram.org/bots/webapps)
- [Telegram Web App JS API](https://core.telegram.org/bots/webapps#initializing-mini-apps)
- [BotFather Commands](https://core.telegram.org/bots#botfather)

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –õ–æ–∫–∞–ª—å–Ω–æ (–±–µ–∑ Mini App)

```env
TELEGRAM_USE_MINIAPP=false
FRONTEND_URL=http://localhost:3000
```

–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ‚Üí –∫–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä–æ–µ—Ç localhost –≤ –±—Ä–∞—É–∑–µ—Ä–µ

### 2. Production (—Å Mini App)

```env
TELEGRAM_USE_MINIAPP=true
FRONTEND_URL=https://app.posutka.com
```

–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ‚Üí –∫–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä–æ–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏ Telegram

## –ü—Ä–∏–º–µ—Ä: –ü–æ–ª–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è production

### 1. Backend (.env):

```env
# Database
DATABASE_URL=postgresql://user:password@db:5432/posutka

# Servers
PORT=4011
GRPC_PORT=4111
WS_PORT=4020

# Telegram
TELEGRAM_BOT_TOKEN=1234567890:ABCdefGHIjklMNOpqrsTUVwxyz
TELEGRAM_USE_MINIAPP=true
TELEGRAM_POLLING=false

# Frontend URL
FRONTEND_URL=https://app.posutka.com

# Environment
NODE_ENV=production
```

### 2. Frontend (index.html):

```html
<!DOCTYPE html>
<html>
<head>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="module" src="/src/main.tsx"></script>
</body>
</html>
```

### 3. Frontend (main.tsx):

```typescript
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
if (window.Telegram?.WebApp) {
  const tg = window.Telegram.WebApp;
  tg.ready();
  tg.expand();
  
  // –ü—Ä–∏–º–µ–Ω—è–µ–º theme Telegram
  document.documentElement.style.cssText = `
    --tg-theme-bg-color: ${tg.themeParams.bg_color};
    --tg-theme-text-color: ${tg.themeParams.text_color};
    --tg-theme-button-color: ${tg.themeParams.button_color};
    --tg-theme-button-text-color: ${tg.themeParams.button_text_color};
  `;
}

// –í–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
ReactDOM.createRoot(document.getElementById('root')!).render(
  <App />
);
```

---

**–î–∞—Ç–∞:** 19 –æ–∫—Ç—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

