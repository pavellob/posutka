# โ ะะฐัััะพะตะฝะฐ ัััะปะบะฐ ะฝะฐ ะดะธะฐะปะพะณ ะดะตัะฐะปะตะน ัะฑะพัะบะธ

## ะงัะพ ัะดะตะปะฐะฝะพ

### 1. ะะฑะฝะพะฒะปะตะฝะฐ ัััะฐะฝะธัะฐ `/cleanings` ะดะปั ัะฐะฑะพัั ั URL ะฟะฐัะฐะผะตััะฐะผะธ

**ะคะฐะนะป:** `frontend/backoffice/src/app/(app)/cleanings/page.tsx`

ะขะตะฟะตัั ะฟัะธ ะฟะตัะตัะพะดะต ะฟะพ ัััะปะบะต `/cleanings?id={cleaningId}` ะฐะฒัะพะผะฐัะธัะตัะบะธ ะพัะบััะฒะฐะตััั ัััะตััะฒัััะธะน `CleaningDetailsDialog` ั:
- โ ะกัะฐัััะพะผ ัะฑะพัะบะธ (SCHEDULED, IN_PROGRESS, COMPLETED, CANCELLED)
- โ ะะฝัะพัะผะฐัะธะตะน ะพ ะบะฒะฐััะธัะต ะธ ัะฑะพััะธะบะต
- โ ะะฐัะฐะผะธ ะฟะปะฐะฝะธัะพะฒะฐะฝะธั, ะฝะฐัะฐะปะฐ ะธ ะทะฐะฒะตััะตะฝะธั
- โ ะะพะฝัะฐะบัะฐะผะธ ัะฑะพััะธะบะฐ (ัะตะปะตัะพะฝ, email)
- โ ะงะตะบ-ะปะธััะพะผ ัะฑะพัะบะธ ั ะพัะพะฑัะฐะถะตะฝะธะตะผ ะฟัะพะณัะตััะฐ
- โ ะะพะบัะผะตะฝัะฐะผะธ ะฟัะธะตะผะบะธ ะธ ัะดะฐัะธ ั ัะพัะพะณัะฐัะธัะผะธ
- โ ะะฐะผะตัะบะฐะผะธ
- โ ะกะฒัะทัั ั ะทะฐะดะฐัะฐะผะธ

### 2. ะะทะผะตะฝะตะฝั ัััะปะบะธ ะฒ ัะฒะตะดะพะผะปะตะฝะธัั

**ะคะฐะนะป:** `backend/cleaning-subgraph/src/services/notification-client.ts`

ะัะต ัััะปะบะธ ัะตะฟะตัั ะธัะฟะพะปัะทััั query ะฟะฐัะฐะผะตัั ะฒะผะตััะพ ะดะธะฝะฐะผะธัะตัะบะพะณะพ ัะพััะฐ:
- ะัะปะพ: `/cleanings/${cleaningId}`
- ะกัะฐะปะพ: `/cleanings?id=${cleaningId}`

ะัะธ ะบะปะธะบะต ะฝะฐ ะบะฝะพะฟะบั ะฒ Telegram:
1. ะัะบััะฒะฐะตััั ัััะฐะฝะธัะฐ `/cleanings?id=...`
2. ะะฒัะพะผะฐัะธัะตัะบะธ ะพัะบััะฒะฐะตััั ะดะธะฐะปะพะณ `CleaningDetailsDialog`
3. ะัะธ ะทะฐะบัััะธะธ ะดะธะฐะปะพะณะฐ URL ะพัะธัะฐะตััั ะพะฑัะฐัะฝะพ ะฝะฐ `/cleanings`

### 3. ะะฐัััะพะตะฝ dotenv ะดะปั cleaning-subgraph

**ะะทะผะตะฝะตะฝะธั:**
- ะฃััะฐะฝะพะฒะปะตะฝ ะฟะฐะบะตั `dotenv`
- ะะพะฑะฐะฒะปะตะฝะฐ ะทะฐะณััะทะบะฐ `.env` ะฒ ะฝะฐัะฐะปะต `server.ts`
- ะะพะฑะฐะฒะปะตะฝะพ ะปะพะณะธัะพะฒะฐะฝะธะต `FRONTEND_URL` ะฟัะธ ะธะฝะธัะธะฐะปะธะทะฐัะธะธ `NotificationClient`

### 4. ะัะฟัะฐะฒะปะตะฝะฐ ะฝะฐัััะพะนะบะฐ FRONTEND_URL

**ะฃะฑัะฐะฝะพ ะธะท:**
- `backend/notifications-subgraph/env.example` - ะฟะตัะตะผะตะฝะฝะฐั ะฝะต ะฝัะถะฝะฐ, ั.ะบ. notifications-subgraph ัะพะปัะบะพ ะฟะตัะตััะปะฐะตั ะณะพัะพะฒัะต ัััะปะบะธ
- `backend/notifications-subgraph/README.md` - ัะดะฐะปะตะฝะฐ ะดะพะบัะผะตะฝัะฐัะธั ะฟัะพ FRONTEND_URL

**ะะพะฑะฐะฒะปะตะฝั ะฒะฐะถะฝัะต ะบะพะผะผะตะฝัะฐัะธะธ ะฒ:**
- `backend/cleaning-subgraph/env.example`
- `env.example` (ะบะพัะตะฝั ะฟัะพะตะบัะฐ)

โ๏ธ **ะะฐะถะฝะพะต ะทะฐะผะตัะฐะฝะธะต ะฟัะพ Telegram:**
```bash
# โ๏ธ ะะะะะ: Telegram ะฝะต ะฟัะธะฝะธะผะฐะตั localhost URL ะฒ ะบะฝะพะฟะบะฐั!
# ะะปั ะปะพะบะฐะปัะฝะพะน ัะฐะทัะฐะฑะพัะบะธ ะธัะฟะพะปัะทัะนัะต ngrok: https://ngrok.com/
# ะัะธะผะตั: FRONTEND_URL=https://your-subdomain.ngrok-free.dev
```

### 5. ะะฑะฝะพะฒะปะตะฝ docker-compose.yml

ะะพะฑะฐะฒะปะตะฝะพ `env_file: - .env` ะดะปั ะฐะฒัะพะผะฐัะธัะตัะบะพะน ะทะฐะณััะทะบะธ ะฟะตัะตะผะตะฝะฝัั ะพะบััะถะตะฝะธั.

## ะะฐะบ ะธัะฟะพะปัะทะพะฒะฐัั

### ะะพะบะฐะปัะฝะฐั ัะฐะทัะฐะฑะพัะบะฐ

1. **ะะฐะฟัััะธัะต ngrok ะดะปั ััะพะฝัะตะฝะดะฐ:**
   ```bash
   ngrok http 3000
   ```

2. **ะกะพะทะดะฐะนัะต `.env` ัะฐะนะป ะฒ ะบะพัะฝะต ะฟัะพะตะบัะฐ:**
   ```bash
   FRONTEND_URL=https://your-subdomain.ngrok-free.dev
   TELEGRAM_BOT_TOKEN=your_bot_token_here
   DATABASE_URL=postgresql://postgres:postgres@localhost:5432/posutka
   NODE_ENV=development
   ```

3. **ะกะพะทะดะฐะนัะต `.env` ะฒ `backend/cleaning-subgraph`:**
   ```bash
   PORT=4010
   FRONTEND_URL=https://your-subdomain.ngrok-free.dev
   NOTIFICATIONS_ENDPOINT=http://localhost:4011/graphql
   DATABASE_URL=postgresql://postgres:postgres@localhost:5432/posutka
   NODE_ENV=development
   ```

4. **ะะตัะตะทะฐะฟัััะธัะต Docker:**
   ```bash
   docker-compose down
   docker-compose build
   docker-compose up
   ```

5. **ะกะพะทะดะฐะนัะต ัะตััะพะฒัั ัะฑะพัะบั**

6. **ะัะบัะพะนัะต ัััะปะบั ะธะท Telegram ัะฒะตะดะพะผะปะตะฝะธั** - ะดะพะปะถะฝะฐ ะพัะบัััััั ัััะฐะฝะธัะฐ ั ะฟะพะปะฝะพะน ะธะฝัะพัะผะฐัะธะตะน ะพะฑ ัะฑะพัะบะต

### ะกัััะบัััะฐ ัััะฐะฝะธัั `/cleanings/[id]`

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ โ ะฃะฑะพัะบะธ                            โ
โ                                     โ
โ ะฃะฑะพัะบะฐ #cmgu2vrk    [SCHEDULED]    โ
โ ะะฒะฐััะธัะฐ ยท ะกะผะตะฝะฐ ะฟะพััะตะปัะฝะพะณะพ ะฑะตะปัั  โ
โ                                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                     โ
โ [ะะฒะฐััะธัะฐ]  [ะฃะฑะพััะธะบ]  [ะะฐัะฐ]      โ
โ                                     โ
โ [ะะฐัะฐะปะพ]    [ะะฐะฒะตััะตะฝะธะต]            โ
โ                                     โ
โ ะะพะฝัะฐะบัั ัะฑะพััะธะบะฐ                   โ
โ ๐ +7 xxx    โ๏ธ email               โ
โ                                     โ
โ ะงะตะบะปะธัั ัะฑะพัะบะธ                      โ
โ โ ะะฐะดะฐัะฐ 1                          โ
โ โ ะะฐะดะฐัะฐ 2                          โ
โ                                     โ
โ ะะพะบัะผะตะฝัั ะธ ัะพัะพะณัะฐัะธะธ              โ
โ ๐ธ ะัะธะตะผะบะฐ ะะ ัะฑะพัะบะธ                โ
โ [ัะพัะพ] [ัะพัะพ] [ัะพัะพ]                โ
โ                                     โ
โ ๐ธ ะกะดะฐัะฐ ะะะกะะ ัะฑะพัะบะธ               โ
โ [ัะพัะพ] [ัะพัะพ] [ัะพัะพ]                โ
โ                                     โ
โ ะะฐะผะตัะบะธ                             โ
โ ...                                 โ
โ                                     โ
โ ะกะฒัะทะฐะฝะฝะฐั ะทะฐะดะฐัะฐ                    โ
โ [ะะตัะตะนัะธ ะบ ะทะฐะดะฐัะฐะผ โ]               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ะัะพะฒะตัะบะฐ ัะฐะฑะพัั

### 1. ะัะพะฒะตัััะต ะฟะตัะตะผะตะฝะฝัั ะพะบััะถะตะฝะธั

```bash
docker exec -it posutka-app env | grep FRONTEND_URL
```

ะะพะปะถะฝะพ ะฒัะฒะตััะธ:
```
FRONTEND_URL=https://your-subdomain.ngrok-free.dev
```

### 2. ะัะพะฒะตัััะต ะปะพะณะธ ะฟัะธ ััะฐััะต cleaning-subgraph

```bash
docker logs posutka-app | grep "NotificationClient initialized"
```

ะะพะปะถะฝะพ ะฑััั:
```
NotificationClient initialized { 
  endpoint: 'http://localhost:4011/graphql',
  frontendUrl: 'https://your-subdomain.ngrok-free.dev',
  envFrontendUrl: 'https://your-subdomain.ngrok-free.dev'
}
```

### 3. ะกะพะทะดะฐะนัะต ัะตััะพะฒัั ัะฑะพัะบั

```graphql
mutation {
  scheduleCleaning(input: {
    orgId: "your-org-id"
    cleanerId: "your-cleaner-id"
    unitId: "your-unit-id"
    scheduledAt: "2025-10-20T10:00:00Z"
    requiresLinenChange: true
  }) {
    id
  }
}
```

### 4. ะัะพะฒะตัััะต ะปะพะณะธ ะพัะฟัะฐะฒะบะธ ัะฒะตะดะพะผะปะตะฝะธั

```bash
docker logs posutka-app | grep "Cleaning assigned notification sent"
```

ะะพะปะถะฝะพ ะฑััั:
```
Cleaning assigned notification sent { 
  cleaningId: '...',
  actionUrl: 'https://your-subdomain.ngrok-free.dev/cleanings/...'
}
```

### 5. ะัะบัะพะนัะต ัััะปะบั ะธะท Telegram

- ะะฐะถะผะธัะต ะฝะฐ ะบะฝะพะฟะบั "ะัะบัััั ะดะตัะฐะปะธ ัะฑะพัะบะธ โ" ะฒ Telegram
- ะะพะทะผะพะถะฝะพ ะฟะพัะฒะธััั ัััะฐะฝะธัะฐ ngrok warning - ะฝะฐะถะผะธัะต "Visit Site"
- ะะพะปะถะฝะฐ ะพัะบัััััั ัััะฐะฝะธัะฐ ั ะดะตัะฐะปัะผะธ ัะฑะพัะบะธ

## ะััะธัะตะบัััะฐ

```
โโโโโโโโโโโโโโโโโโโโโโโโ
โ cleaning-subgraph    โ
โ                      โ
โ โ process.env.      โ
โ    FRONTEND_URL      โ
โ                      โ
โ NotificationClient   โ
โ getFrontendUrl()     โ
โ โ                    โ
โ /cleanings?id={id}   โ
โโโโโโโโโโโโฌโโโโโโโโโโโโ
           โ
           โ ะะพะปะฝะฐั ัััะปะบะฐ
           โ https://ngrok.../cleanings?id=123
           โ
           โผ
โโโโโโโโโโโโโโโโโโโโโโโโ
โ notifications-       โ
โ subgraph             โ
โ                      โ
โ โ ะะ ะธัะฟะพะปัะทัะตั     โ
โ    FRONTEND_URL      โ
โ                      โ
โ ะัะพััะพ ะฟะตัะตััะปะฐะตั    โ
โ ะณะพัะพะฒัั ัััะปะบั       โ
โโโโโโโโโโโโฌโโโโโโโโโโโโ
           โ
           โผ
      ๐ค Telegram Bot
           โ
           โผ
      ๐ค ะะพะปัะทะพะฒะฐัะตะปั
           โ
           โ ะะปะธะบ ะฟะพ ะบะฝะพะฟะบะต
           โผ
โโโโโโโโโโโโโโโโโโโโโโโโ
โ Frontend             โ
โ                      โ
โ /cleanings           โ
โ page.tsx             โ
โ                      โ
โ useEffect ัะธัะฐะตั     โ
โ query param 'id'     โ
โ โ                    โ
โ ะพัะบััะฒะฐะตั ะดะธะฐะปะพะณ     โ
โ CleaningDetails      โ
โ Dialog               โ
โโโโโโโโโโโโโโโโโโโโโโโโ
```

## ะคะฐะนะปั ะธะทะผะตะฝะตะฝั

1. โ `frontend/backoffice/src/app/(app)/cleanings/page.tsx` - ะดะพะฑะฐะฒะปะตะฝ useSearchParams ะธ useEffect ะดะปั ััะตะฝะธั ?id=
2. โ `backend/cleaning-subgraph/src/services/notification-client.ts` - ะธะทะผะตะฝะตะฝั ัััะปะบะธ ะฝะฐ query ะฟะฐัะฐะผะตััั
3. โ `backend/cleaning-subgraph/src/server.ts` - ะดะพะฑะฐะฒะปะตะฝ dotenv
4. โ `backend/cleaning-subgraph/env.example` - ะดะพะฑะฐะฒะปะตะฝั ะบะพะผะผะตะฝัะฐัะธะธ ะฟัะพ ngrok
5. โ `backend/notifications-subgraph/env.example` - ัะฑัะฐะฝ FRONTEND_URL
6. โ `backend/notifications-subgraph/README.md` - ัะฑัะฐะฝ FRONTEND_URL ะธะท ะดะพะบัะผะตะฝัะฐัะธะธ
7. โ `docker-compose.yml` - ะดะพะฑะฐะฒะปะตะฝ `env_file`
8. โ `env.example` - ะดะพะฑะฐะฒะปะตะฝั ะบะพะผะผะตะฝัะฐัะธะธ ะฟัะพ ngrok

## ะกะปะตะดัััะธะต ัะฐะณะธ

1. ะกะพะทะดะฐะนัะต `.env` ัะฐะนะป ั ะฒะฐัะธะผ ngrok URL
2. ะกะพะทะดะฐะนัะต `.env` ะฒ `backend/cleaning-subgraph`
3. ะะตัะตะทะฐะฟัััะธัะต Docker
4. ะัะพัะตััะธััะนัะต ัะพะทะดะฐะฝะธะต ัะฑะพัะบะธ
5. ะัะพะฒะตัััะต, ััะพ ัััะปะบะฐ ะธะท Telegram ะพัะบััะฒะฐะตั ัััะฐะฝะธัั `/cleanings` ั ะดะธะฐะปะพะณะพะผ ะดะตัะฐะปะตะน

