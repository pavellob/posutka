# Исправление проблемы с Turbo Cache и Next.js

## Проблема

При билде лендингов постоянно возникала ошибка:
```
Error: <Html> should not be imported outside of pages/_document.
```

## Причина

**Turbo агрессивно кешировал весь `.next` директорий**, включая скомпилированные файлы Next.js.

### Что происходило:

1. Turbo сохранял **весь** `.next/**` в свой кеш (строка в `turbo.json`: `"outputs": ["dist/**", ".next/**"]`)
2. При следующем билде Turbo восстанавливал **скомпилированные файлы** из кеша
3. Эти закешированные файлы были **несовместимы** с текущими версиями зависимостей (Next.js 15 + React 19)
4. Возникала ошибка в файле `.next/server/chunks/383.js`

## Решение

### 1. Обновлена конфигурация `turbo.json` (root)

**Было:**
```json
"build": { "dependsOn": ["^build"], "outputs": ["dist/**", ".next/**"] }
```

**Стало:**
```json
"build": { 
  "dependsOn": ["^build"], 
  "outputs": ["dist/**"]
}
```

### 2. Создан `turbo.json` в каждом Next.js лендинге

Создали файлы `frontend/*/turbo.json` для каждого лендинга:

```json
{
  "extends": ["//"],
  "tasks": {
    "build": {
      "cache": false
    }
  }
}
```

### Что изменилось:

- ❌ **Полностью отключено кеширование для Next.js сборок**
- ✅ Next.js сам управляет своим кешем через встроенный `.next/cache`
- ✅ Backend пакеты (subgraphs) продолжают кешироваться - они не подвержены этой проблеме
- ✅ Это на 100% предотвращает несовместимость скомпилированных файлов

### 3. Очищены старые кеши

```bash
rm -rf .turbo                    # Удален Turbo cache
rm -rf frontend/*/.next          # Удалены все .next директории
pnpm store prune                 # Очищен pnpm store
pnpm install --force             # Переустановлены зависимости
```

## Почему это не было видно раньше

- Код лендингов **не менялся** - проблема была в кеше
- Turbo пытался "помочь" переиспользуя билды, но создавал проблемы
- Next.js 15 + React 19 очень чувствительны к версиям зависимостей

## Как избежать в будущем

1. ✅ Новая конфигурация `turbo.json` предотвращает эту проблему
2. Если ошибка повторится, запустите:
   ```bash
   rm -rf .turbo && rm -rf frontend/*/.next
   ```
3. Для полной очистки:
   ```bash
   pnpm store prune
   pnpm install --force
   ```

## Дата исправления

26 октября 2025

