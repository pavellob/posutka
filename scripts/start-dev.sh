#!/bin/bash

echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº Ð²ÑÐµÑ… ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²..."

# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¿Ð¾Ð´Ð³Ñ€Ð°Ñ„Ñ‹ Ð² Ñ„Ð¾Ð½Ðµ
echo "ðŸ“¦ Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ð¾Ð´Ð³Ñ€Ð°Ñ„Ð¾Ð²..."
pnpm start:subgraphs &
SUBDGRAPHS_PID=$!

# Ð–Ð´ÐµÐ¼ Ð³Ð¾Ñ‚Ð¾Ð²Ð½Ð¾ÑÑ‚Ð¸ Ð¿Ð¾Ð´Ð³Ñ€Ð°Ñ„Ð¾Ð²
echo "â³ ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð³Ð¾Ñ‚Ð¾Ð²Ð½Ð¾ÑÑ‚Ð¸ Ð¿Ð¾Ð´Ð³Ñ€Ð°Ñ„Ð¾Ð²..."
./scripts/wait-for-subgraphs.sh

if [ $? -eq 0 ]; then
  echo "âœ… ÐŸÐ¾Ð´Ð³Ñ€Ð°Ñ„Ñ‹ Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹!"
  
  # Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ ÑÑƒÐ¿ÐµÑ€Ð³Ñ€Ð°Ñ„
  echo "ðŸ”§ Ð¡Ð±Ð¾Ñ€ÐºÐ° ÑÑƒÐ¿ÐµÑ€Ð³Ñ€Ð°Ñ„Ð°..."
  pnpm mesh:compose
  
  if [ $? -eq 0 ]; then
    echo "âœ… Ð¡ÑƒÐ¿ÐµÑ€Ð³Ñ€Ð°Ñ„ ÑÐ¾Ð±Ñ€Ð°Ð½!"
    
    # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ gateway
    echo "ðŸŒ Ð—Ð°Ð¿ÑƒÑÐº gateway..."
    pnpm start:gateway
  else
    echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑÐ±Ð¾Ñ€ÐºÐµ ÑÑƒÐ¿ÐµÑ€Ð³Ñ€Ð°Ñ„Ð°"
    kill $SUBDGRAPHS_PID 2>/dev/null
    exit 1
  fi
else
  echo "âŒ ÐŸÐ¾Ð´Ð³Ñ€Ð°Ñ„Ñ‹ Ð½Ðµ Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹"
  kill $SUBDGRAPHS_PID 2>/dev/null
  exit 1
fi
