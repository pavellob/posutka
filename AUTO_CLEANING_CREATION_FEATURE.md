# ✨ Автоматическое создание уборок при назначении уборщика

## Что изменилось

Теперь при назначении уборщика на задачу типа `CLEANING` **автоматически создается запись уборки** со статусом "Запланирована".

### До изменений:
1. Создавали задачу CLEANING
2. Назначали уборщика
3. ❌ Уборка не создавалась - нужно было вручную идти на страницу /cleanings и создавать

### После изменений:
1. Создаете задачу CLEANING
2. Назначаете уборщика
3. ✅ **Автоматически создается уборка со статусом "Запланирована"**
4. ✅ Уборка сразу появляется на странице `/cleanings`
5. ✅ Создается базовый чеклист (8 пунктов)

## Как использовать

### Шаг 1: Создайте уборщиков
```
Страница /cleanings → Вкладка "Уборщики" → "+ Добавить уборщика"
```

### Шаг 2: Создайте задачу уборки
```
Страница /tasks → "Создать задачу" → Тип: CLEANING
```

### Шаг 3: Назначьте уборщика
```
В списке задач → найдите задачу CLEANING → "Назначить" → Выберите уборщика
```

### Результат:
```
✅ Успешно!

• Уборщик [Имя Фамилия] назначен на задачу
• Уборка создана и добавлена в список со статусом "Запланирована"

Перейти на страницу уборок? [OK] [Отмена]
```

Нажмите "OK" чтобы сразу перейти на страницу `/cleanings` и увидеть созданную уборку.

## Что создается автоматически

### 1. Запись Task
- `assignedCleanerId` - ID назначенного уборщика
- Статус остается `TODO` или меняется на `IN_PROGRESS` (опционально)

### 2. Запись Cleaning
- **Status:** `SCHEDULED` (Запланирована)
- **Cleaner:** назначенный уборщик
- **Unit:** квартира из задачи
- **Booking:** бронирование из задачи (если есть)
- **TaskId:** связь с исходной задачей
- **ScheduledAt:** дата из `dueAt` задачи или текущая дата
- **Notes:** "Создано автоматически при назначении уборщика"
- **RequiresLinenChange:** `false` (по умолчанию)

### 3. Базовый чеклист (8 пунктов)
1. Пропылесосить все комнаты
2. Помыть полы
3. Протереть пыль
4. Убрать в ванной
5. Убрать на кухне
6. Сменить постельное белье
7. Проверить все приборы
8. Вынести мусор

## Технические детали

### Измененные файлы:

**Frontend:**
- `frontend/backoffice/src/app/(app)/tasks/page.tsx`

### Добавленная логика:

```typescript
const handleAssignTask = async (taskId: string, assigneeId: string, taskType: string) => {
  if (taskType === 'CLEANING') {
    // 1. Назначаем уборщика на задачу
    await assignTaskMutation.mutateAsync({
      taskId,
      cleanerId: assigneeId
    })
    
    // 2. Автоматически создаем уборку
    await scheduleCleaningMutation.mutateAsync({
      orgId,
      cleanerId: assigneeId,
      unitId: task.unit?.id,
      bookingId: task.booking?.id,
      taskId: taskId,
      scheduledAt: task.dueAt || new Date().toISOString(),
      notes: 'Создано автоматически при назначении уборщика',
      requiresLinenChange: false,
      checklistItems: [/* 8 пунктов */]
    })
    
    // 3. Показываем уведомление с предложением перейти к уборкам
    if (confirm('Уборка создана! Перейти на страницу уборок?')) {
      window.location.href = '/cleanings'
    }
  }
}
```

### Используемые мутации:

1. **ASSIGN_TASK** (ops-subgraph)
   - Назначает `cleanerId` на Task
   
2. **SCHEDULE_CLEANING** (cleaning-subgraph)
   - Создает новую запись Cleaning

## Преимущества

✅ **Автоматизация** - не нужно вручную создавать уборку
✅ **Меньше кликов** - все происходит за один шаг
✅ **Консистентность** - уборка всегда связана с задачей через `taskId`
✅ **Базовый чеклист** - сразу готов к использованию
✅ **Моментальная видимость** - уборка сразу в списке на `/cleanings`

## Статусы уборки

После создания уборка проходит следующие статусы:

1. **SCHEDULED** (Запланирована) - создается автоматически
2. **IN_PROGRESS** (В процессе) - когда уборщик начинает работу
3. **COMPLETED** (Завершена) - когда уборщик завершает все пункты
4. **CANCELLED** (Отменена) - если уборка отменяется

## Обработка ошибок

Если автоматическое создание уборки не удалось:

```
⚠️ Уборщик назначен на задачу, но не удалось автоматически создать запись уборки.

Пожалуйста, создайте уборку вручную через страницу /cleanings 
или кнопку "Выполнить уборку".
```

В этом случае:
- Уборщик все равно назначен на задачу
- Можно создать уборку вручную через:
  - Страницу `/cleanings` → "Запланировать уборку"
  - Или на странице `/tasks` → "Выполнить уборку"

## Дальнейшая работа с уборкой

После создания уборки вы можете:

1. **Просмотреть детали:**
   - `/cleanings` → найти уборку → "Подробнее"

2. **Начать выполнение:**
   - `/tasks` → "Выполнить уборку"
   - Или `/cleanings` → "Начать уборку"

3. **Заполнить чеклист:**
   - Отметить выполненные пункты
   - Добавить фотографии до/после
   - Создать документы приемки/сдачи

4. **Завершить уборку:**
   - Когда все пункты выполнены
   - Статус изменится на COMPLETED

## Связанная документация

- `CLEANING_TASKS_ASSIGNMENT_UPDATE.md` - основная документация по назначению уборщиков
- Схема БД: `packages/datalayer-prisma/prisma/schema.prisma`
- GraphQL схема cleaning: `backend/cleaning-subgraph/src/schema/index.gql`
- GraphQL схема ops: `backend/ops-subgraph/src/schema/index.gql`

## Тестирование

Для тестирования функции:

1. Запустите приложение локально
2. Создайте уборщика на `/cleanings`
3. Создайте задачу CLEANING на `/tasks`
4. Назначьте уборщика → должна появиться уборка на `/cleanings`
5. Проверьте статус "Запланирована"
6. Проверьте чеклист (8 пунктов)

## Возможные улучшения в будущем

- [ ] Использовать шаблоны чеклистов вместо хардкода
- [ ] Добавить настройку автоматического создания в настройках
- [ ] Отправлять уведомление уборщику
- [ ] Интеграция с календарем
- [ ] Push-уведомления при создании уборки

