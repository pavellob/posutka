version: 1

services:
  # Posutka GraphQL Federation (все сервисы в одном контейнере)
  posutka-federation:
    source:
      type: image
      dockerfile: Dockerfile
      context: .
    resources:
      memory: 1Gi
      cpu: 500m
           ports:
             - port: 4000  # Gateway (основной порт)
               protocol: http
             - port: 4001  # Inventory Subgraph
               protocol: http
             - port: 4002  # Bookings Subgraph (GraphQL)
               protocol: http
             - port: 4102  # Bookings Subgraph (gRPC)
               protocol: http
             - port: 4003  # Ops Subgraph (GraphQL)
               protocol: http
             - port: 4103  # Ops Subgraph (gRPC)
               protocol: http
             - port: 4004  # Billing Subgraph
               protocol: http
             - port: 4005  # Identity Subgraph
               protocol: http
             - port: 4006  # Listings Subgraph
               protocol: http
             - port: 4007  # Legal Subgraph
               protocol: http
             - port: 4008  # AI Subgraph
               protocol: http
             - port: 4009  # IAM Subgraph
               protocol: http
             - port: 4010  # Cleaning Subgraph
               protocol: http
             - port: 4011  # Notifications Subgraph (GraphQL)
               protocol: http
             - port: 4111  # Notifications Subgraph (gRPC)
               protocol: http
             - port: 4020  # Notifications WebSocket
               protocol: http
    environment:
      - name: NODE_ENV
        value: production
      - name: DATABASE_URL
        fromSecret: database-url
      - name: FRONTEND_URL
        # ⚠️ ВАЖНО: Установите в Northflank UI!
        # Должен быть HTTPS URL мобильного приложения для уборщиков (Telegram Mini App)
        # Пример: https://app.kakadu.com или https://cleaners.posutka.com
      - name: TELEGRAM_BOT_TOKEN
        fromSecret: telegram-bot-token
      - name: TELEGRAM_USE_MINIAPP
        value: "true"
      - name: TELEGRAM_POLLING
        value: "false"
      - name: NOTIFICATIONS_GRPC_HOST
        value: localhost
      - name: NOTIFICATIONS_GRPC_PORT
        value: "4111"
      - name: MINIO_URL
        fromSecret: minio-url
      - name: MINIO_ACCESS_KEY
        fromSecret: minio-access-key
      - name: MINIO_SECRET_KEY
        fromSecret: minio-secret-key
      - name: MINIO_BUCKET
        fromSecret: minio-bucket
    healthCheck:
      path: /graphql
      port: 4000
      initialDelaySeconds: 180  # Даем время на запуск всех сервисов
      periodSeconds: 20
      timeoutSeconds: 120
